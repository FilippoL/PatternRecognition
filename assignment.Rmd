---
title: "R Notebook"
output:
  html_document:
    df_print: paged
  html_notebook: default
  pdf_document: default
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

*Run* = *Ctrl+Shift+Enter*. 
*Insert Chunk* = *Ctrl+Alt+I*.
*Ctrl+Shift+K* = *Preview*


The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.


```{r warning=FALSE}
library(OpenImageR) 
library(dplyr)
library(iterators)
library(nnet)
library(reshape2)
library(ggplot2)
```
```{r}
mnist.dat <- read.csv("mnist.csv")
pixels_data = mnist.dat[,-1]
scaled_pixels_data = scale(pixels_data)
scaled_pixels_data[is.na(scaled_pixels_data)] = 0 #Replacing NaN with 0
mnist.dat$label = as.factor(mnist.dat$label)
```
```{r}
show_image_from_data = function(data, row) {
  sample_image = t(matrix(as.numeric(data[row,-1]),nrow=28,ncol=28,byrow=T)[c(28:1),,drop = FALSE])
  return (image(sample_image, axes = FALSE, col = grey(seq(0, 1, length = 256)), asp=1))
}
show_image_data = function(actual_digit) {
  return (t(matrix(as.numeric(actual_digit),nrow=28,ncol=28,byrow=T))[,c(28:1),drop = FALSE])
}
show_image_from_data(mnist.dat, 1)  

```
```{r}
mnist.summary = data.frame(t(sapply( pixels_data , function(x) cbind(mean = mean(x) ,
                                  sd = sd(x) ,
                                  median = median(x) ,
                                  minimum = min(x) ,
                                  maximum = max(x) ,
                                  s.size = length(x)))))
colnames(mnist.summary) = c("mean","sd","median","minimum","maximum","size")
```
```{r}
head(mnist.summary[mnist.summary$sd==0,])
```
```{r}
indices_of_useless_features = which(mnist.summary$sd == 0)
actual_digit = mnist.dat[90,-1]
actual_digit[,indices_of_useless_features] = 125
digit_example = show_image_data(actual_digit)
image(digit_example, axes = FALSE, col = grey(seq(0, 1, length = 256)), asp=1)
```
```{r}
indices_of_useless_features = which(mnist.summary$sd < 1)
actual_digit = mnist.dat[400,-1]
actual_digit[,indices_of_useless_features] = 125
digit_example = show_image_data(actual_digit)
image(digit_example, axes = FALSE, col = grey(seq(0, 1, length = 256)), asp=1)
```

```{r}
# Plot count of each digit's pixel in barplot and then display it in a table
label_distribution = table(mnist.dat[,1]) 
barplot(label_distribution, col=rainbow(10, 0.5), main="Digits in dataset")
# as.data.frame(mnist.dat) %>% group_by(label) %>% summarise(count = n())
```
```{r}
expected_accuracy_on_majority_label_classification = label_distribution[2] / sum(label_distribution)
sprintf("Accuracy if 1 was predicted for all labels: %.2f %%", expected_accuracy_on_majority_label_classification * 100)
```

Threshold decision

[useful link](https://stackoverflow.com/questions/25360248/arrange-multiple-32-png-files-in-a-grid/51865036#51865036)

Even after removing some data we can still see the picture as follows:

```{r}
actual_digit = mnist.dat[450,-1]
indices_of_useful_features = which(actual_digit < 248)
actual_digit[,indices_of_useful_features] = 0
digit_example = show_image_data(actual_digit)
image(digit_example, axes = FALSE, col = grey(seq(0, 1, length = 256)), asp=1)
```

```{r}
hist(as.numeric(actual_digit))

```

```{r}
hist.data = hist(as.matrix(mnist.dat[,-1]), breaks=32)
hist.data$counts = log10(hist.data$counts)
plot(hist.data)
axis(side=1, at=seq(0, 256, 8))
```

```{r}
# indices_of_useful_features = 
# function(x) x[which(x < 248)] = 0
cleaned_images = t(apply(pixels_data, MARGIN = 1, FUN=function(x) replace(x, which(x < 248), 0)))
image_density = apply(cleaned_images, MARGIN=1, FUN=function(x) sum(x))
image_density_per_pixel = apply(data.frame(image_density), MARGIN=1, FUN=function(x) sum(x)/784) # Calculate density
data = cbind.data.frame(density=image_density, density_per_pixel=image_density_per_pixel, scaled_density = scale(image_density), label=mnist.dat$label)
head(data)
```

```{r}
summary_per_digit = rbind.data.frame(tapply(data$density_per_pixel, data$label,  function(x) cbind(mean = mean(x) ,
                                  sd = sd(x) ,
                                  median = median(x) ,
                                  minimum = min(x) ,
                                  maximum = max(x),
                                  s.size = length(x))
                           ))
rownames(summary_per_digit) = c("mean","sd","median","minimum","maximum","size") 
#TODO: Plot all distributions
data.frame(t(summary_per_digit))
```

```{r}
cormat = dist(t(summary_per_digit[c("mean","sd"),]))
data.frame(as.matrix(cormat))
```
```{r}
# melted_cormat <- melt(as.matrix(cormat))
# ggplot(data = melted_cormat, aes(x=Var1, y=Var2, fill=value)) + geom_tile()
cormat = dist(t(summary_per_digit[c("mean","sd","median","minimum","maximum"),]))
melted_cormat <- melt(as.matrix(cormat))
ggplot(data = melted_cormat, aes(x=Var1, y=Var2, fill=value)) + geom_tile()
```
```{r}
density_model = multinom(label ~ scaled_density, data, maxit=5000)
density_model
```

